# 
# Copyright (C) 2006-2008 OpenWrt.org
#
# This is free software, licensed under the GNU General Public License v2.
# See /LICENSE for more information.
#

include $(TOPDIR)/rules.mk

PKG_NAME:=postfix
PKG_RELEASE:=33
PKG_SOURCE_URL:=http://esls.susu.ac.ru/postfix/official/
PKG_VERSION:=2.8.1
PKG_MD5SUM:=3be685a786d36d310cc77b0567b98215

PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION).tar.gz

include $(INCLUDE_DIR)/package.mk

define Package/postfix
  SECTION:=net
  CATEGORY:=Mail
  TITLE:=Postfix Mail Transmit Agent
  URL:=http://www.postfix.org/
  MAINTAINER:=Denis Shulyaka <Shulyaka@gmail.com>
  DEPENDS:=+tinycdb +shadow-useradd +shadow-groupadd +shadow-userdel +shadow-groupdel
endef

define Package/postfix/description
 Postfix is Wietse Venema's mailer that started life as an alternative to the widely-used Sendmail program. Postfix attempts to be fast, easy to administer, and secure, while at the same time being sendmail compatible enough to not upset existing users. Thus, the outside has a sendmail-ish flavor, but the inside is completely different.
endef

define Package/postfix/conffiles
/etc/postfix/main.cf
/etc/postfix/aliases
endef

define Build/Configure
	cd $(PKG_BUILD_DIR); CDB=$(BUILD_DIR)/tinycdb-0.77/ $(MAKE) makefiles CCARGS="-DHAS_CDB -I$(BUILD_DIR)/tinycdb-0.77/ -I$(STAGING_DIR)/usr/include/" $(TARGET_CONFIGURE_OPTS) prefix="$(PKG_INSTALL_DIR)/usr" AUXLIBS="-L$(STAGING_DIR)/usr/lib $(BUILD_DIR)/tinycdb-0.77/libcdb.a"
endef

define Build/Compile
	cd $(PKG_BUILD_DIR); $(MAKE) PATH_DB_H=/usr/include/db.h $(TARGET_CONFIGURE_OPTS) prefix="$(PKG_INSTALL_DIR)/usr" CC="$(TARGET_CC) -I$(STAGING_DIR)/usr/include/ -DNO_EPOLL -DNO_SIGSETJMP -DHAS_CDB -I$(BUILD_DIR)/tinycdb-0.77/"
	# recompiling postconf natively because we need it executable:
	cp -r $(PKG_BUILD_DIR)/src/util $(PKG_BUILD_DIR)/src/util.native
	cp -r $(PKG_BUILD_DIR)/src/xsasl $(PKG_BUILD_DIR)/src/xsasl.native
	cp -r $(PKG_BUILD_DIR)/src/global $(PKG_BUILD_DIR)/src/global.native
	cp -r $(PKG_BUILD_DIR)/src/postconf $(PKG_BUILD_DIR)/src/postconf.native
	
	cd $(PKG_BUILD_DIR)/src/util.native; $(MAKE) clean && $(MAKE) CC=$(HOSTCC)
	cd $(PKG_BUILD_DIR)/src/xsasl.native; $(MAKE) clean && $(MAKE) CC=$(HOSTCC)
	cd $(PKG_BUILD_DIR)/src/global.native; $(MAKE) clean && $(MAKE) CC=$(HOSTCC)
	cd $(PKG_BUILD_DIR)/src/postconf.native; $(HOSTCC) -DNO_EPOLL -DNO_SIGSETJMP -g -O -I. -I../../include -DLINUX2 -c postconf.c && $(HOSTCC) -DNO_EPOLL -DNO_SIGSETJMP -g -O -I. -I../../include -DLINUX2 -o postconf postconf.o ../xsasl.native/libxsasl.a ../global.native/libglobal.a ../util.native/libutil.a -lnsl -lresolv
	#exit 1
	mv $(PKG_BUILD_DIR)/bin/postconf $(PKG_BUILD_DIR)/bin/postconf.target
	cp $(PKG_BUILD_DIR)/src/postconf.native/postconf $(PKG_BUILD_DIR)/bin/postconf
	rm -rf $(PKG_BUILD_DIR)/src/util.native $(PKG_BUILD_DIR)/src/xsasl.native $(PKG_BUILD_DIR)/src/global.native $(PKG_BUILD_DIR)/src/postconf.native
	# fixing main.cf.default that was broken due to postconf:
	(echo "# DO NOT EDIT THIS FILE. EDIT THE MAIN.CF FILE INSTEAD. THE"; \
	echo "# TEXT HERE JUST SHOWS DEFAULT SETTINGS BUILT INTO POSTFIX."; \
	echo "#"; \
	$(PKG_BUILD_DIR)/bin/postconf -d) |egrep -v '^(myhostname|mydomain|mynetworks) ' > $(PKG_BUILD_DIR)/conf/main.cf.default
endef

define Package/postfix/install
	cd $(PKG_BUILD_DIR); $(MAKE) install_root=$(1) readme_directory=no html_directory=no queue_directory=/usr/var/spool/postfix data_directory=/usr/var/lib/postfix non-interactive-package
	# Removing those useless man pages:
	# OK, not removing, since `postfix set-permissions` script has trouble with that. May be later.
	#$(RM) -r $(1)/usr/local/man
	# restoring target postconf:
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/bin/postconf.target $(1)/usr/sbin/postconf
	# fixing configuration (we don't want mail directory to be on tmpfs):
	$(PKG_BUILD_DIR)/bin/postconf -c $(1)/etc/postfix/ -e \
	"data_directory = /usr/var/lib/postfix" \
	"mail_spool_directory = /usr/var/mail"
	$(INSTALL_DIR) $(1)/usr/var/lib/postfix
	$(INSTALL_DIR) $(1)/usr/var/mail
	$(INSTALL_DIR) $(1)/etc/init.d/
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/postfix_init $(1)/etc/init.d/postfix
endef

define Package/postfix/postinst
#!/bin/sh
if [ `grep -c postfix /etc/passwd` -eq 0 ]
then
 groupadd postfix  # We'll need to remove shadow dependency and make postfix run as root later.
 groupadd postdrop
 useradd postfix -g postfix -d /var -s /bin/false
fi
if [ ! -f /etc/services ] || [ `grep -c smtp /etc/services` -eq 0 ]
then
 echo "smtp            25/tcp          mail" >> /etc/services
 echo "smtp            25/udp          mail" >> /etc/services
fi
# /etc/init.d/postfix enable
postfix set-permissions
postfix upgrade-configuration
newaliases
if [ `ps | grep "postfix/master" | grep -cv grep` -gt 0 ]
then
 postfix reload
fi
endef

define Package/postfix/prerm
#!/bin/sh
if [ `ps | grep "postfix/master" | grep -cv grep` -gt 0 ]
then
 postfix stop
fi
endef

define Package/postfix/postrm
#!/bin/sh
userdel postfix
groupdel postfix
groupdel postdrop
rm -f /etc/postfix/aliases.cdb # /usr/var/lib/postfix/master.lock
endef

$(eval $(call BuildPackage,postfix))
